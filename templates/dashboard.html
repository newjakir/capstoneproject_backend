{% extends 'partials/base.html' %}

{% block title %}Dashboard{% endblock %}

{% load static %}

{% load custom_filters %}

{% block content %}
<div class="container-fluid">

     <!-- Start here.... -->
     {% if request.user.is_admin %}
     <div class="row">
          <div class="col-xxl-6">
               <div class="row">
                    <!-- Order Statistics -->
                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-primary rounded">
                                                  <iconify-icon icon="solar:cart-5-bold-duotone"
                                                       class="avatar-title fs-32 text-primary"></iconify-icon>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Orders</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ total_orders }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-warning rounded">
                                                  <iconify-icon icon="solar:cart-5-bold-duotone"
                                                       class="avatar-title fs-32 text-warning"></iconify-icon>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Pending Orders</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ pending_orders }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-success rounded">
                                                  <iconify-icon icon="solar:cart-5-bold-duotone"
                                                       class="avatar-title fs-32 text-success"></iconify-icon>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Confirmed Orders</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ confirmed_orders }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Revenue Statistics -->
                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-primary rounded">
                                                  <i class="bx bx-dollar-circle avatar-title text-primary fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Revenue</p>
                                             <h3 class="text-dark mt-1 mb-0">${{ total_revenue|divide:1000|floatformat:3 }}K</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-info rounded">
                                                  <i class="bx bx-dollar-circle avatar-title text-info fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">POS Revenue</p>
                                             <h3 class="text-dark mt-1 mb-0">${{ total_pos_sales|divide:1000|floatformat:3 }}K</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-info rounded">
                                                  <i class="bx bx-dollar-circle avatar-title text-info fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Ecom Revenue</p>
                                             <h3 class="text-dark mt-1 mb-0">${{ total_ecom_sales|divide:1000|floatformat:3 }}K</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <div class="col-xxl-6">
               <div class="row">
                    <!-- Inventory & Customer Statistics -->
                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-success rounded">
                                                  <i class="bx bx-category avatar-title text-success fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Categories</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ total_categories }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-primary rounded">
                                                  <i class="bx bx-package avatar-title text-primary fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Products</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ total_products }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-success rounded">
                                                  <i class="bx bx-user avatar-title text-success fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Customers</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ total_customers }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <!-- Financial Statistics -->
                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-danger rounded">
                                                  <i class="bx bx-money avatar-title text-danger fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Due</p>
                                             <h3 class="text-dark mt-1 mb-0">${{ total_due|divide:1000|floatformat:3 }}K</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-success rounded">
                                                  <i class="bx bx-dollar-circle avatar-title text-success fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Total Profit</p>
                                             <h3 class="text-dark mt-1 mb-0">${{ total_profit|divide:1000|floatformat:3 }}K</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>

                    <div class="col-md-6">
                         <div class="card overflow-hidden">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-6">
                                             <div class="avatar-md bg-soft-warning rounded">
                                                  <i class="bx bx-gift avatar-title text-warning fs-24"></i>
                                             </div>
                                        </div>
                                        <div class="col-6 text-end">
                                             <p class="text-muted mb-0 text-truncate">Active Coupons</p>
                                             <h3 class="text-dark mt-1 mb-0">{{ active_coupons }}</h3>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </div>
     </div>
     {% endif %}


     <!-- <div class="row">
          <div class="col-xxl-6">
               <div class="card">
                    <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center">
                              <h4 class="card-title">Performance</h4>
                              <div>
                                   <button type="button" class="btn btn-sm btn-outline-light">ALL</button>
                                   <button type="button" class="btn btn-sm btn-outline-light">1M</button>
                                   <button type="button" class="btn btn-sm btn-outline-light">6M</button>
                                   <button type="button" class="btn btn-sm btn-outline-light active">1Y</button>
                              </div>
                         </div> 

                         <div dir="ltr">
                              <div id="dash-performance-chart" class="apex-charts"></div>
                         </div>
                    </div> 
               </div> 
          </div>
     </div>  -->

     {% if request.user.is_admin %}
     <div class="row">

          <div class="col-lg-4">
               <div class="card card-height-100">
                    <div class="card-header d-flex align-items-center justify-content-between gap-2">
                         <h4 class="card-title flex-grow-1">Visitors By Country</h4>

                         <!-- <a href="#" class="btn btn-sm btn-soft-primary">View All</a> -->
                    </div>
                    <div class="table-responsive">
                         <table class="table table-hover table-nowrap table-centered m-0">
                              <thead class="bg-light bg-opacity-50">
                                   <tr>
                                        <th class="text-muted ps-3">Country</th>
                                        <th class="text-muted">Visitors</th>
                                   </tr>
                              </thead>
                              <tbody>
                                   {% for visitor in visitor_country %}
                                   <tr>
                                        <td class="ps-3"><a href="#" class="text-muted">{{visitor.country}}</a></td>
                                        <td><span class="badge badge-soft-success">{{visitor.count}}</span></td>
                                   </tr>
                                   {% endfor %}
                              </tbody>
                         </table>
                    </div>
               </div>
          </div>

          <div class="col-lg-8">
               <div class="card card-height-100">
                    <div class="card-header d-flex align-items-center justify-content-between gap-2">
                         <h4 class="card-title flex-grow-1">Top Products</h4>

                         <!-- <a href="#" class="btn btn-sm btn-soft-primary">View All</a> -->
                    </div>
                    <div class="table-responsive">
                         <table class="table table-hover table-nowrap table-centered m-0">
                              <thead class="bg-light bg-opacity-50">
                                   <tr>
                                        <th class="text-muted ps-3">Page Path</th>
                                        <th class="text-muted">Page Views</th>
                                        <th class="text-muted">Purchase Unit</th>
                                   </tr>
                              </thead>
                              <tbody>
                                   {% for product in top_products %}
                                   <tr>
                                        <td class="ps-3"><a href="#" class="text-muted">{{product.name}}</a></td>
                                        <td><span class="badge badge-soft-success">{{product.total_views}}</span></td>
                                        <td><span class="badge badge-soft-success">{{product.total_units_sold}}</span></td>
                                   </tr>
                                   {% endfor %}
                              </tbody>
                         </table>
                    </div>
               </div>
          </div>
     </div>
     {% endif %}

     <div class="row">
          <div class="col">
               <div class="card">
                    <div class="card-body">
                         <div class="d-flex align-items-center justify-content-between">
                              <h4 class="card-title">
                                   Recent Pos Sales
                              </h4>
                         </div>
                    </div>
                    <!-- end card body -->
                    <div class="table-responsive table-centered">
                         <table class="table mb-0">
                              <thead class="bg-light bg-opacity-50">
                                   <tr>
                                        <th class="ps-3">
                                             Order Id.
                                        </th>
                                        <th class="ps-3">
                                             Invoice Number.
                                        </th>
                                        <th>
                                             Date
                                        </th>
                                        <th>
                                             Total
                                        </th>
                                        <th>
                                             Due
                                        </th>
                                        <th>
                                             Payment Type
                                        </th>
                                        <th>
                                             Status
                                        </th>
                                   </tr>
                              </thead>
                              <!-- end thead-->
                              <tbody>
                                   {% for sale in recent_pos_sales %}
                                   <tr>
                                        <td class="ps-3">
                                             <a href="admin/pos/pos/{{ sale.id }}/" target="_blank">{{ sale.id }}</a>
                                        </td>
                                        <td class="ps-3">
                                             <a href="pos/invoice/{{sale.id}}/" target="_blank">{{ sale.invoice_number }}</a>
                                        </td>
                                        <td>{{ sale.sale_date }}</td>
                                        <td>{{ sale.total_amount }}</td>
                                        <td>{{ sale.due_amount }}</td>
                                        <td>{{ sale.payment_method|title }}</td>
                                        <td>
                                             {% if sale.status == 'pending' %}
                                                  <i class="bx bxs-circle text-warning me-1"></i>Pending
                                             {% elif sale.status == 'paid' %}
                                                  <i class="bx bxs-circle text-success me-1"></i>Paid
                                             {% elif sale.status == 'cancelled' %}
                                                  <i class="bx bxs-circle text-danger me-1"></i>Cancelled
                                             {% elif sale.status == 'due' %}
                                                  <i class="bx bxs-circle text-info me-1"></i>Due
                                             {% endif %}
                                        </td>
                                   </tr>
                                   {% endfor %}
                              </tbody>
                              <!-- end tbody -->
                         </table>
                         <!-- end table -->
                    </div>
               </div>
               <!-- end card -->
          </div>
          <!-- end col -->
     </div> <!-- end row -->

     {% if request.user.is_admin %}
     <div class="row">
          <div class="col">
               <div class="card">
                    <div class="card-body">
                         <div class="d-flex align-items-center justify-content-between">
                              <h4 class="card-title">
                                   Recent Ecommerce Orders
                              </h4>
                         </div>
                    </div>
                    <!-- end card body -->
                    <div class="table-responsive table-centered">
                         <table class="table mb-0">
                              <thead class="bg-light bg-opacity-50">
                                   <tr>
                                        <th class="ps-3">
                                             Order ID.
                                        </th>
                                        <th>
                                             Date
                                        </th>
                                        <th>
                                             Customer Name
                                        </th>
                                        <th>
                                             Email ID
                                        </th>
                                        <th>
                                             Phone No.
                                        </th>
                                        <th>
                                             Amount
                                        </th>
                                        <th>
                                             Payment Type
                                        </th>
                                        <th>
                                             Status
                                        </th>
                                   </tr>
                              </thead>
                              <!-- end thead-->
                              <tbody>
                                   {% for order in recent_orders %}
                                   <tr>
                                        <td class="ps-3">
                                             <a href="/admin/core/order/{{order.id}}/" target="_blank">{{ order.order_id }}</a>
                                        </td>
                                        <td>{{ order.created_at }}</td>
                                        <td>
                                             <a href="/admin/core/user/{{order.user.id}}/" target="_blank">{{ order.user.first_name }} {{ order.user.last_name }}</a>
                                        </td>
                                        <td>{{ order.user.email }}</td>
                                        <td>{{ order.user.phone_number }}</td>
                                        <td>${{ order.total_price }}</td>
                                        <td>
                                             {% if order.payment_status == 'pending' %}
                                                  <i class="bx bxs-circle text-warning me-1"></i>Pending
                                             {% elif order.payment_status == 'paid' %}
                                                  <i class="bx bxs-circle text-success me-1"></i>Paid
                                             {% elif order.payment_status == 'failed' %}
                                                  <i class="bx bxs-circle text-danger me-1"></i>Failed
                                             {% endif %}
                                        </td>
                                        <td>
                                             {% if order.order_status == 'pending' %}
                                                  <i class="bx bxs-circle text-warning me-1"></i>Pending
                                             {% elif order.order_status == 'confirmed' %}
                                                  <i class="bx bxs-circle text-info me-1"></i>Confirmed
                                             {% elif order.order_status == 'shipped' %}
                                                  <i class="bx bxs-circle text-primary me-1"></i>Shipped
                                             {% elif order.order_status == 'delivered' %}
                                                  <i class="bx bxs-circle text-success me-1"></i>Delivered
                                             {% elif order.order_status == 'canceled' %}
                                                  <i class="bx bxs-circle text-danger me-1"></i>Canceled
                                             {% endif %}
                                        </td>
                                   </tr>
                                   {% endfor %}
                              </tbody>
                              <!-- end tbody -->
                         </table>
                         <!-- end table -->
                    </div>
               </div>
               <!-- end card -->
          </div>
          <!-- end col -->
     </div>
     {% endif %}

     <div class="row">
          <div class="col">
               <div class="card">
                    <div class="card-body">
                         <div class="d-flex align-items-center justify-content-between">
                              <h4 class="card-title">
                                   Stock Alert
                              </h4>
                         </div>
                    </div>
                    <!-- end card body -->
                    <div class="table-responsive table-centered">
                         <table class="table mb-0">
                              <thead class="bg-light bg-opacity-50">
                                   <tr>
                                        <th class="ps-3">Product SKU</th>
                                        <th>Image</th>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>Current Stock</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                   </tr>
                              </thead>
                              <!-- end thead-->
                              <tbody>
                                   {% for product in stock_alert_products %}
                                   <tr>
                                        <td class="ps-3">
                                             <a href="{% url 'admin:core_product_change' product.id %}" target="_blank">
                                                  {{ product.sku }}
                                             </a>
                                        </td>
                                        <td>
                                             {% if product.image %}
                                             <img src="{{ product.image.url }}" alt="{{ product.name }}" class="rounded" style="width: 48px; height: 48px; object-fit: cover;">
                                             {% else %}
                                             <div class="rounded bg-light" style="width: 48px; height: 48px;"></div>
                                             {% endif %}
                                        </td>
                                        <td>{{ product.name }}</td>
                                        <td>{{ product.category.name }}</td>
                                        <td>
                                             <span class="{% if product.stock_quantity <= product.alert_quantity %}text-danger{% endif %}">
                                                  {{ product.stock_quantity }}
                                             </span>
                                        </td>
                                        <td>
                                             {% if product.stock_quantity == 0 %}
                                                  <span class="badge bg-danger">Out of Stock</span>
                                             {% else %}
                                                  <span class="badge bg-warning">Low Stock</span>
                                             {% endif %}
                                        </td>
                                        <td>
                                             <a href="{% url 'admin:core_product_change' product.id %}" 
                                                class="btn btn-sm btn-primary" 
                                                target="_blank">
                                                  Update Stock
                                             </a>
                                        </td>
                                   </tr>
                                   {% empty %}
                                   <tr>
                                        <td colspan="8" class="text-center py-4">
                                             <p class="text-muted mb-0">No products with low stock</p>
                                        </td>
                                   </tr>
                                   {% endfor %}
                              </tbody>
                              <!-- end tbody -->
                         </table>
                         <!-- end table -->
                    </div>
               </div>
               <!-- end card -->
          </div>
          <!-- end col -->
     </div>

</div>
{% endblock %}